<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üå∏ S·∫ÆC ƒê·∫∏P D√ÇN T·ªòC TH√ÅI</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root { --primary: #8B0000; --gold: #FFD700; --bg: #fdf5f5; }
    body { font-family: 'Nunito', sans-serif; margin: 0; background: var(--bg); color: #333; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    header { background: var(--primary); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 3px solid var(--gold); }
    .nav-bar { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
    .nav-link { color: white; text-decoration: none; font-weight: bold; padding: 8px 20px; border-radius: 25px; transition: 0.3s; }
    .nav-link.active { background: var(--gold); color: var(--primary); }
    
    section { padding: 40px 0; }
    .hidden { display: none; }
    
    /* Grid S·∫£n Ph·∫©m */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
    .p-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; transition: 0.4s; border: 1px solid #eee; }
    .p-card:hover { transform: translateY(-10px); box-shadow: 0 10px 25px rgba(139,0,0,0.2); }
    .p-card img { width: 100%; height: 280px; object-fit: cover; }
    .p-info { padding: 20px; text-align: center; }
    .p-info h3 { margin: 0 0 10px 0; font-size: 1.2em; }
    .p-price { color: var(--primary); font-weight: 800; font-size: 1.3em; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 15px; }
    .modal-content { background: white; width: 100%; max-width: 900px; border-radius: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-body { display: flex; flex-wrap: wrap; padding: 30px; gap: 25px; }
    .modal-left, .modal-right { flex: 1; min-width: 320px; }
    #main-img { width: 100%; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .thumb-list { display: flex; gap: 10px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; }
    .thumb-list img { width: 70px; height: 70px; border-radius: 10px; cursor: pointer; object-fit: cover; border: 2px solid #eee; }

    /* Form & Input */
    input, textarea { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 1em; }
    .btn { background: var(--primary); color: white; border: none; padding: 15px 25px; border-radius: 35px; font-weight: 800; cursor: pointer; width: 100%; margin-top: 15px; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
    .btn:hover { background: #600000; transform: scale(1.02); }

    /* Tra c·ª©u */
    .track-box { max-width: 550px; margin: auto; text-align: center; background: white; padding: 40px; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.05); }
    #track-res { margin-top: 30px; }

    @media (max-width: 768px) { .modal-left, .modal-right { min-width: 100%; } }
  </style>
</head>
<body>

<header>
  <h1 style="margin:0; letter-spacing: 1px;">üå∏ S·∫ÆC ƒê·∫∏P D√ÇN T·ªòC TH√ÅI</h1>
  <div class="nav-bar">
    <a href="#home" class="nav-link active">TRANG CH·ª¶</a>
    <a href="#track" class="nav-link">TRA C·ª®U ƒê∆†N</a>
  </div>
</header>

<div class="container">
  <section id="home">
    <div class="product-grid" id="product-list">ƒêang t·∫£i s·∫£n ph·∫©m t·ª´ h·ªá th·ªëng...</div>
  </section>

  <section id="track" class="hidden">
    <div class="track-box">
      <h2 style="color:var(--primary); margin-bottom:10px;">üîç TRA C·ª®U ƒê∆†N H√ÄNG</h2>
      <p style="color:#666; margin-bottom:20px;">Nh·∫≠p m√£ ƒë∆°n ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i v√† ti·∫øn ƒë·ªô giao h√†ng</p>
      <input type="text" id="track-input" placeholder="V√≠ d·ª•: SDT1234">
      <button class="btn" onclick="checkOrder()">T√åM KI·∫æM NGAY</button>
      <div id="track-res"></div>
    </div>
  </section>
</div>

<div id="product-modal" class="modal">
  <div class="modal-content">
    <div style="position:absolute; right:20px; top:15px; z-index:10;"><i class="fa fa-times-circle" onclick="closeModal()" style="font-size:32px; cursor:pointer; color:#ccc;"></i></div>
    
    <div id="step-1" class="modal-body">
      <div class="modal-left">
        <img id="main-img" src="">
        <div class="thumb-list" id="thumb-list"></div>
      </div>
      <div class="modal-right">
        <h2 id="p-title" style="margin-top:0; color:var(--primary);"></h2>
        <p id="p-id" style="color:#999; font-weight:bold;"></p>
        <p class="p-price" id="p-price"></p>
        <div id="p-desc" style="white-space: pre-line; line-height: 1.8; margin:20px 0; color:#444;"></div>
        <button class="btn" onclick="goToStep(2)">MUA NGAY & C·ªåC 50%</button>
      </div>
    </div>

    <div id="step-2" class="modal-body hidden">
      <div style="width:100%">
        <h3 style="text-align:center; color:var(--primary);">üõí TH√îNG TIN KH√ÅCH H√ÄNG</h3>
        <input type="text" id="f-name" placeholder="H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n...">
        <input type="text" id="f-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i Zalo...">
        <input type="email" id="f-email" placeholder="Email nh·∫≠n th√¥ng b√°o ƒë∆°n h√†ng...">
        <textarea id="f-address" rows="3" placeholder="ƒê·ªãa ch·ªâ giao h√†ng chi ti·∫øt..."></textarea>
        <button class="btn" onclick="processPayment()">TI·∫æP T·ª§C ƒê·ªÇ L·∫§Y M√É QR</button>
        <button class="btn" style="background:#ddd; color:#666;" onclick="goToStep(1)">QUAY L·∫†I</button>
      </div>
    </div>

    <div id="step-3" class="modal-body hidden" style="text-align:center;">
      <div style="width:100%">
        <h3 style="color:#2ecc71;">M√É QR THANH TO√ÅN C·ªåC (50%)</h3>
        <p>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ghi nh·∫≠n ƒë∆°n sau khi b·∫°n qu√©t m√£ th√†nh c√¥ng.</p>
        <img id="qr-code" style="max-width:300px; border:8px solid #f9f9f9; border-radius:20px; margin:15px 0;">
        <div style="background:#fff4e6; padding:15px; border-radius:15px; border:1px dashed #ffa94d;">
           <b style="color:#333;">N·ªôi dung chuy·ªÉn kho·∫£n:</b><br>
           <span id="qr-info" style="color:#d9480f; font-size:1.2em; font-weight:900;"></span>
        </div>
        <p style="margin-top:15px;">M√£ ƒë∆°n h√†ng c·ªßa b·∫°n: <b id="final-id" style="color:var(--primary)"></b></p>
        <button class="btn" onclick="finalSubmit()">T√îI ƒê√É CHUY·ªÇN KHO·∫¢N XONG</button>
      </div>
    </div>
  </div>
</div>

<script>
    // --- C·∫§U H√åNH (THAY LINK C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
    const URLS = {
        db: 'LINK_CSV_TAB_SAN_PHAM', 
        track: 'LINK_CSV_TAB_THEO_DOI_DON', 
        script: 'LINK_WEB_APP_EXEC_MOI' 
    };

    let DB = { products: [], settings: {} };
    let CURRENT_P = null;
    let ORDER_TEMP = {};

    // Kh·ªüi t·∫°o l·∫•y d·ªØ li·ªáu
    async function init() {
        try {
            const res = await fetch(URLS.db + '&cache=' + Math.random());
            const text = await res.text();
            const data = Papa.parse(text, { header: true }).data;
            DB.products = data.filter(r => r.id);
            DB.settings = data.find(r => r.bank_id) || {};
            renderProducts();
        } catch (e) { console.error("L·ªói t·∫£i d·ªØ li·ªáu!"); }
    }

    function renderProducts() {
        document.getElementById('product-list').innerHTML = DB.products.map(p => {
            let cleanPrice = p.price.toString().replace(/\./g, '').replace(/,/g, '');
            return `
                <div class="p-card" onclick="openProduct('${p.id}')">
                    <img src="${p.img || 'https://via.placeholder.com/400x400?text=San+Pham'}" onerror="this.src='https://via.placeholder.com/400x400?text=Loi+Anh'">
                    <div class="p-info">
                        <h3>${p.title}</h3>
                        <p class="p-price">${Number(cleanPrice).toLocaleString('vi-VN')} VNƒê</p>
                    </div>
                </div>`;
        }).join('');
    }

    function openProduct(id) {
        CURRENT_P = DB.products.find(x => x.id === id);
        const mainImg = document.getElementById('main-img');
        mainImg.src = CURRENT_P.img || 'https://via.placeholder.com/600x600';
        
        let priceVal = CURRENT_P.price.toString().replace(/\./g, '').replace(/,/g, '');
        document.getElementById('p-price').innerText = Number(priceVal).toLocaleString('vi-VN') + " VNƒê";
        document.getElementById('p-title').innerText = CURRENT_P.title;
        document.getElementById('p-id').innerText = "M√£ s·∫£n ph·∫©m: " + CURRENT_P.id;
        document.getElementById('p-desc').innerText = CURRENT_P.desc || "";

        const gallery = [CURRENT_P.img];
        if(CURRENT_P.gallery) gallery.push(...CURRENT_P.gallery.split(','));
        document.getElementById('thumb-list').innerHTML = gallery.map(u => 
            `<img src="${u.trim()}" onclick="document.getElementById('main-img').src=this.src">`
        ).join('');

        goToStep(1);
        document.getElementById('product-modal').style.display = 'flex';
    }

    function goToStep(s) {
        [1,2,3].forEach(n => document.getElementById('step-'+n).classList.add('hidden'));
        document.getElementById('step-'+s).classList.remove('hidden');
    }

    function processPayment() {
        const name = document.getElementById('f-name').value.trim();
        const phone = document.getElementById('f-phone').value.trim();
        const email = document.getElementById('f-email').value.trim();
        if(!name || !phone || !email) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß T√™n, SƒêT v√† Email!");

        let cleanPrice = CURRENT_P.price.toString().replace(/\./g, '').replace(/,/g, '');
        let total = parseInt(cleanPrice);
        let deposit = total / 2;
        let oId = "SDT" + Math.floor(1000 + Math.random() * 9000);
        let info = `${CURRENT_P.id} ${oId} ${name.replace(/\s/g,'')}`;

        ORDER_TEMP = {
            order_id: oId, customer_name: name, phone: phone, email: email,
            address: document.getElementById('f-address').value, product_id: CURRENT_P.id,
            product_name: CURRENT_P.title, total_price: total, note: "Kh√°ch ƒë·∫∑t c·ªçc 50%"
        };

        document.getElementById('qr-code').src = `https://img.vietqr.io/image/${DB.settings.bank_id}-${DB.settings.bank_account}-compact.png?amount=${deposit}&addInfo=${encodeURIComponent(info)}`;
        document.getElementById('qr-info').innerText = info;
        document.getElementById('final-id').innerText = oId;
        goToStep(3);
    }

    async function finalSubmit() {
        const btn = document.querySelector('button[onclick="finalSubmit()"]');
        btn.innerText = "H·ªÜ TH·ªêNG ƒêANG L∆ØU ƒê∆†N..."; btn.disabled = true;
        try {
            await fetch(URLS.script, { method: 'POST', mode: 'no-cors', body: JSON.stringify(ORDER_TEMP) });
            alert("ƒê√É G·ª¨I ƒê∆†N TH√ÄNH C√îNG!\nC·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô S·∫Øc ƒê·∫πp D√¢n T·ªôc Th√°i.");
            closeModal();
        } catch(e) { alert("L·ªói k·∫øt n·ªëi b·ªô n√£o!"); }
        btn.innerText = "T√îI ƒê√É CHUY·ªÇN KHO·∫¢N XONG"; btn.disabled = false;
    }

    // --- LOGIC TRA C·ª®U TI·∫æNG VI·ªÜT 100% ---
    async function checkOrder() {
        const idInput = document.getElementById('track-input').value.trim().toUpperCase();
        const resDiv = document.getElementById('track-res');
        if(!idInput) return alert("Vui l√≤ng nh·∫≠p m√£ ƒë∆°n!");
        
        resDiv.innerHTML = "üîç ƒêang tra c·ª©u d·ªØ li·ªáu ƒë∆°n h√†ng " + idInput + "...";

        try {
            const r = await fetch(URLS.track + '&cache=' + Math.random());
            const txt = await r.text();
            // D√πng Papaparse v·ªõi header ƒë·ªÉ g·ªçi ƒë√∫ng t√™n c·ªôt ti·∫øng Vi·ªát
            const orders = Papa.parse(txt, { header: true, delimiter: '\t' }).data;
            const found = orders.find(o => o["M√£ ƒë∆°n h√†ng"] && o["M√£ ƒë∆°n h√†ng"].toString().toUpperCase() === idInput);

            if(found) {
                let color = found["Tr·∫°ng th√°i"] === 'ƒê√£ x√°c nh·∫≠n' ? '#2ecc71' : '#e74c3c';
                resDiv.innerHTML = `
                <div style="background:#fff; padding:25px; border-radius:20px; text-align:left; border-left:10px solid ${color}; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
                    <h3 style="margin-top:0; color:${color}; font-size:1.5em;">${found["Tr·∫°ng th√°i"]}</h3>
                    <p><b>üì¶ M√£ ƒë∆°n:</b> ${found["M√£ ƒë∆°n h√†ng"]}</p>
                    <p><b>üë§ Kh√°ch h√†ng:</b> ${found["T√™n kh√°ch h√†ng"]}</p>
                    <p><b>üëó S·∫£n ph·∫©m:</b> ${found["M√£ s·∫£n ph·∫©m"]}</p>
                    <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                    <p><b>üöö Ti·∫øn ƒë·ªô:</b> <span style="color:#2980b9; font-weight:bold;">${found["Ti·∫øn ƒë·ªô"]}</span></p>
                    <p><b>üìù Ghi ch√∫:</b> <i>${found["Ghi ch√∫"]}</i></p>
                </div>`;
            } else { resDiv.innerHTML = "<div style='color:red; font-weight:bold;'>‚ùå Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n n√†y!</div>"; }
        } catch(e) { resDiv.innerHTML = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi d·ªØ li·ªáu CSV!"; }
    }

    function closeModal() { document.getElementById('product-modal').style.display = 'none'; }
    
    // Chuy·ªÉn Tab trang ch·ªß / Tra c·ª©u
    document.querySelectorAll('.nav-link').forEach(l => {
        l.onclick = (e) => {
            e.preventDefault();
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelector(l.getAttribute('href')).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
            l.classList.add('active');
        };
    });

    init();
</script>
</body>
</html>
