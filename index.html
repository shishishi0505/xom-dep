<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üå∏ S·∫ÆC ƒê·∫∏P D√ÇN T·ªòC</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --primary-red: #8B0000;
      --secondary-gold: #FFD700;
      --trans-white: rgba(255, 255, 255, 0.4); 
      --trans-cream: rgba(255, 255, 255, 0.25);
      --blur-bg: blur(12px);
    }

    .menu-toggle { position: fixed; top: 20px; right: 20px; z-index: 1001;
        background: var(--primary-red); color: white; width: 45px; height: 45px;
        border-radius: 10px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .menu-note { position: fixed; top: 75px; right: 20px; z-index: 1000;
        background: rgba(0,0,0,0.6); color: white; padding: 8px 12px;
        border-radius: 10px; font-size: 13px; text-align: center;
    }
    .success-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; padding: 30px; border-radius: 20px; text-align: center;
        z-index: 3000; box-shadow: 0 0 30px rgba(0,0,0,0.5); display: none; width: 90%; max-width: 400px;
    }
    .countdown { font-size: 14px; color: #666; margin-top: 10px; }

    .history-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px;
        margin-bottom: 10px; border-left: 5px solid var(--secondary-gold); text-align: left; color: white;
    }

    .blog-post-full { text-align: left; line-height: 1.8; color: #ffffff; font-size: 17px; padding: 30px; 
        background: rgba(0, 0, 0, 0.4); border-radius: 25px; margin-top: 20px; border: 1px solid var(--secondary-gold); }
    .blog-post-full img { max-width: 100%; height: auto; border-radius: 15px; margin: 20px auto; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    body { font-family: 'Nunito', sans-serif; margin: 0; background-attachment: fixed; background-size: cover; background-position: center; color: #333; transition: 0.5s; }
    header { padding: 40px 20px 10px; text-align: center; }
    header h1 { font-size: clamp(28px, 5vw, 42px); color: white; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); margin: 0; }
    nav { background: var(--trans-white); backdrop-filter: var(--blur-bg); padding: 10px; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; gap: 10px; }
    nav a { text-decoration: none; color: var(--primary-red); font-weight: 900; padding: 8px 15px; border-radius: 15px; }
    nav a.active { background: var(--primary-red); color: white; }
    .layout { width: 95%; max-width: 1200px; margin: 20px auto; }
    .card { background: var(--trans-cream); backdrop-filter: var(--blur-bg); border-radius: 25px; padding: 25px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); text-align: center; }
    .social-under-poem { margin-top: 20px; display: flex; justify-content: center; gap: 25px; }
    .social-under-poem a { color: var(--secondary-gold); font-size: 28px; text-shadow: 1px 1px 5px black; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
    .product-card { background: var(--trans-white); backdrop-filter: var(--blur-bg); padding: 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
    .product-card img { width: 100%; border-radius: 15px; aspect-ratio: 1/1; object-fit: cover; }
    .tag-id { background: var(--primary-red); color: white; font-size: 10px; padding: 2px 8px; border-radius: 5px; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 10px; }
    .modal-content { background: white; border-radius: 25px; width: 100%; max-width: 900px; max-height: 95vh; overflow-y: auto; position: relative; }
    .modal-body { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .gallery-main { width: 100%; border-radius: 15px; transition: 0.3s; }
    .thumb-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
    .thumb-grid img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; cursor: pointer; opacity: 0.6; }
    .order-form input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
    .btn-action { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; }
    .hidden { display: none; }
    .zalo-float { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 999; animation: ring 2s infinite; }
    @keyframes ring { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1) rotate(10deg); } }

    .order-detail {
        background: white; color: black; padding: 20px; border-radius: 15px; text-align: left; line-height: 1.8;
    }
    .order-detail b { color: var(--primary-red); }
    #cart-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 10px; }
    .cart-content { background: white; border-radius: 25px; width: 100%; max-width: 900px; max-height: 95vh; overflow-y: auto; position: relative; padding: 20px; }
    .cart-tab { padding: 10px 20px; background: #eee; border-radius: 15px; cursor: pointer; font-weight: bold; }
    .cart-tab.active { background: var(--primary-red); color: white; }
    .cart-section { display: none; }
    .cart-section.active { display: block; }
    .cart-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; }
    .cart-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; margin-right: 15px; }
    .cart-item input[type="checkbox"] { margin-right: 10px; }
    .cart-total { margin-top: 20px; text-align: right; font-weight: bold; font-size: 18px; color: var(--primary-red); }
    #cart-login { text-align: center; padding: 20px; }
    #cart-login input { width: 100%; max-width: 350px; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; }
    .full-product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 10px; }
    .cart-item-actions { display: flex; flex-direction: column; gap: 5px; margin-left: 10px; }
    .cart-item-actions button { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100px; }
    .cart-item-actions .remove-btn { background: #ccc; color: #333; }
    .cart-item-actions .buy-again-btn { background: #28a745; color: white; }

    /* Toast th·ªëng nh·∫•t ki·ªÉu th√†nh c√¥ng */
    #toast-notification {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        background: rgba(40, 167, 69, 0.95); color: white; padding: 25px 40px; border-radius: 20px; 
        font-size: 18px; font-weight: bold; z-index: 9999; display: none; text-align: center; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); min-width: 300px;
    }
    #toast-notification i { font-size: 50px; color: white; margin-bottom: 15px; display: block; }
  </style>
</head>
<body>

  <!-- C√°c ph·∫ßn HTML gi·ªØ nguy√™n nh∆∞ tr∆∞·ªõc (header, nav, layout, modal, cart-modal, toast, v.v.) -->
  <!-- Ch·ªâ thay ƒë·ªïi m·ªôt s·ªë ph·∫ßn nh·ªè, m√¨nh gi·ªØ nguy√™n c·∫•u tr√∫c ƒë·ªÉ tr√°nh d√†i d√≤ng -->

  <div id="toast-notification">
      <i class="fas fa-check-circle"></i>
      <span id="toast-message">ƒê√£ th√™m v√†o gi·ªè h√†ng!</span>
  </div>

  <script>
    // ... (ph·∫ßn init, render, v.v. gi·ªØ nguy√™n)

    function showToast(message = "ƒê√£ th√™m v√†o gi·ªè h√†ng!") {
        const toast = document.getElementById('toast-notification');
        document.getElementById('toast-message').innerText = message;
        toast.style.display = 'block';
        toast.style.opacity = '1';
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => { toast.style.display = 'none'; }, 500);
        }, 400); // 0.4 gi√¢y hi·ªán
    }

    // Validate t√™n v√† s·ªë ƒëi·ªán tho·∫°i
    function validateUserInput(name, phone) {
        const cleanPhone = phone.replace(/\D/g, '');
        if (cleanPhone.length !== 10) {
            showToast("S·ªë ƒëi·ªán tho·∫°i ph·∫£i ƒë√∫ng 10 ch·ªØ s·ªë!");
            return false;
        }
        if (!name.trim() || name.trim().split(/\s+/).length < 2) {
            showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç v√† T√™n!");
            return false;
        }
        return true;
    }

    function saveCartUser() {
        const name = document.getElementById('cart-name').value.trim();
        const phone = document.getElementById('cart-phone').value.trim();
        const address = document.getElementById('cart-address').value.trim();
        
        if (!validateUserInput(name, phone)) return;

        const userKey = `cart_${name.replace(/\s/g,'_')}_${phone}`;
        if (address) {
            localStorage.setItem(`${userKey}_address`, address);
        }
        
        localStorage.setItem('cart_user_key', userKey);
        showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o " + name.split(' ').pop());
        openCart();
    }

    // Mua l·∫°i t·ª´ gi·ªè h√†ng: b·ªè qua form, ƒëi th·∫≥ng ƒë·∫øn b∆∞·ªõc thanh to√°n QR
    function buyAgainDirect(id) {
        const userKey = localStorage.getItem('cart_user_key');
        if (!userKey) {
            showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
            openCart();
            return;
        }

        const parts = userKey.split('_');
        const name = parts.slice(1, -1).join('_').replace(/_/g, ' ');
        const phone = parts[parts.length - 1];
        const address = localStorage.getItem(`${userKey}_address`) || "Ch∆∞a nh·∫≠p (li√™n h·ªá Zalo)";

        CURRENT_P = DB.products.find(x => x.id === id);
        if (!CURRENT_P) return;

        const orderId = "SDT" + Math.floor(1000 + Math.random() * 9000);
        const deposit = Number(CURRENT_P.price) * 500;
        const qrInfo = `${CURRENT_P.id} ${orderId} ${name.replace(/\s/g,'')}`;

        const orderTemp = {
            "Ng√†y ƒë·∫∑t": new Date().toLocaleDateString('vi-VN'),
            "M√£ ƒë∆°n h√†ng": orderId,
            "M√£ s·∫£n ph·∫©m": CURRENT_P.id,
            "T√™n kh√°ch h√†ng": name,
            "S·ªë ƒëi·ªán tho·∫°i": "'" + phone,
            "Gmail/Zalo": "T·ª´ gi·ªè h√†ng",
            "ƒê·ªãa ch·ªâ": address,
            "T·ªïng ti·ªÅn": (Number(CURRENT_P.price) * 1000).toLocaleString('vi-VN') + " VNƒê",
            "Tr·∫°ng th√°i": "Ch·ªù c·ªçc",
            "Ghi ch√∫": "Mua l·∫°i t·ª´ gi·ªè h√†ng"
        };

        document.getElementById('final-id').innerText = orderId;
        document.getElementById('qr-info').innerText = qrInfo;
        document.getElementById('bank-owner').innerText = "TONG ANH NAM";
        document.getElementById('qr-code').src = `https://img.vietqr.io/image/${DB.settings.bank_id}-${DB.settings.bank_account}-compact.png?amount=${deposit}&addInfo=${encodeURIComponent(qrInfo)}`;

        document.getElementById('product-modal').style.display = 'flex';
        goToStep(3);

        // G·ª≠i d·ªØ li·ªáu v√†o sheet "Gi·ªè h√†ng"
        fetch(URLS.script, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderTemp) 
        });
    }

    function renderCartItems() {
        // ... gi·ªØ nguy√™n ph·∫ßn tr∆∞·ªõc

        html += `
        <div class="cart-item">
            <input type="checkbox" checked data-id="${id}" onchange="updateCartTotal()">
            <img src="${p.img}">
            <div style="flex:1;">
                <h4>${p.title} <small>(${id})</small></h4>
                <b style="color:var(--primary-red)">${(Number(p.price)*1000).toLocaleString('vi-VN')} VNƒê</b>
            </div>
            <div class="cart-item-actions">
                <button class="remove-btn" onclick="removeFromCart('${id}')">X√≥a</button>
                <button class="buy-again-btn" onclick="buyAgainDirect('${id}')">Mua l·∫°i</button>
            </div>
        </div>`;
        
        // ... ph·∫ßn c√≤n l·∫°i
    }

    // ƒê√≥ng modal s·∫£n ph·∫©m kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn gi·ªè h√†ng
    function closeModal() {
        document.getElementById('product-modal').style.display = 'none';
        // Kh√¥ng ƒë√≥ng cart-modal ·ªü ƒë√¢y
    }

    // Khi ƒë√≥ng cart-modal th√¨ m·ªõi th·ª±c s·ª± tho√°t gi·ªè h√†ng
    function closeCartModal() {
        document.getElementById('cart-modal').style.display = 'none';
    }

    // confirmLogout c≈©ng th√™m th√¥ng b√°o toast ki·ªÉu th√†nh c√¥ng
    function confirmLogout() {
        // ... gi·ªØ nguy√™n x√≥a localStorage
        showToast("ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng! Gi·ªè h√†ng ƒë√£ ƒë∆∞·ª£c x√≥a.");
        document.getElementById('logout-confirm').classList.add('hidden');
        closeCartModal();
    }

    // ... ph·∫ßn c√≤n l·∫°i gi·ªØ nguy√™n
  </script>

  <!-- Ph·∫ßn HTML cart-modal v√† toast gi·ªØ nguy√™n nh∆∞ tr∆∞·ªõc -->
</body>
</html>
